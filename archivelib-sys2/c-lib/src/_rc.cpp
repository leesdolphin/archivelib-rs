#include "arclib.h"

#include "_rc.hpp"
#include <stdlib.h>
#include <cstring>

#define _445(_200, _446)                                                       \
  ((int16_t)((_446 << CONST__154) ^ (_278[_200 + 2])) & (CONST__153 - 1))
#define _447(_200, _201)                                                       \
  {                                                                            \
    int16_t _204;                                                              \
    if ((_204 = _163[_201]) != CONST__157)                                     \
      _164[_204] = _200;                                                       \
    _164[_200] = _201;                                                         \
    _163[_200] = _204;                                                         \
    _163[_201] = _200;                                                         \
  }
#define _448(s)                                                                \
  {                                                                            \
    int16_t _204;                                                              \
    if ((_204 = _164[s]) != CONST__157) {                                      \
      _164[s] = CONST__157;                                                    \
      _163[_204] = CONST__157;                                                 \
    }                                                                          \
  }
RCompress::RCompress(ALStorage &_266, ALStorage &_267, int32_t _269,
                     int32_t _235) {
  _161 = &_266;
  _162 = &_267;
  _531 = _235;
  if (_269 > CONST__137 || _269 < CONST__138) {
    mStatus.SetError(AL_ILLEGAL_PARAMETER, _519, _269 - 10);
    _175 = 2;
  } else
    _175 = (int16_t)(1 << _269);
  _176 = (int16_t)(_175 - 1);
  if ((_166 = new uint8_t[_175 + CONST__140 + 2]) != 0)
    memset(_166, 0, (_175 + CONST__140 + 2) * sizeof(uint8_t));
  if ((_163 = new int16_t[_175 + CONST__153]) != 0)
    memset(_163, 0, (_175 + CONST__153) * sizeof(int16_t));
  if ((_164 = new int16_t[_175]) != 0)
    memset(_164, 0, _175 * sizeof(int16_t));
  _165 = new uint8_t[CONST__155];
  _179 = new uint8_t[CONST__156];
  if ((_189 = new uint16_t[2 * CONST__141 - 1]) != 0)
    memset(_189, 0, (2 * CONST__141 - 1) * sizeof(uint16_t));
  if ((_190 = new uint16_t[2 * CONST__141 - 1]) != 0)
    memset(_190, 0, (2 * CONST__141 - 1) * sizeof(uint16_t));
  if ((_177 = new int16_t[CONST__141 + 1]) != 0)
    memset(_177, 0, (CONST__141 + 1) * sizeof(int16_t));
  _180 = new uint8_t[CONST__141];
  if ((_191 = new uint16_t[2 * CONST__141 - 1]) != 0)
    memset(_191, 0, (2 * CONST__141 - 1) * sizeof(uint16_t));
  if ((_192 = new uint16_t[CONST__141]) != 0)
    memset(_192, 0, CONST__141 * sizeof(uint16_t));
  _181 = new uint8_t[CONST__152];
  if ((_193 = new uint16_t[2 * CONST__142 - 1]) != 0)
    memset(_193, 0, (2 * CONST__142 - 1) * sizeof(uint16_t));
  if ((_194 = new uint16_t[CONST__152]) != 0)
    memset(_194, 0, CONST__152 * sizeof(uint16_t));
  if (!_166 || !_163 || !_164 || !_165 || !_179 || !_189 || !_190 || !_177 ||
      !_180 || !_191 || !_192 || !_181 || !_193 || !_194) {
    mStatus.SetError(AL_CANT_ALLOCATE_MEMORY, _520);
  }
  _533 = 0;
  _534 = _266.GetSize();
}
RCompress::~RCompress() {
  if (_166)
    delete[] _166;
  if (_163)
    delete[] _163;
  if (_164)
    delete[] _164;
  if (_165)
    delete[] _165;
  if (_179)
    delete[] _179;
  if (_189)
    delete[] _189;
  if (_190)
    delete[] _190;
  if (_177)
    delete[] _177;
  if (_180)
    delete[] _180;
  if (_191)
    delete[] _191;
  if (_192)
    delete[] _192;
  if (_181)
    delete[] _181;
  if (_193)
    delete[] _193;
  if (_194)
    delete[] _194;
}
inline void RCompress::fn223(int16_t _203) { fn208(_180[_203], _192[_203]); }
int32_t RCompress::Compress() {
  int16_t _209;
  int16_t _201;
  int16_t _200;
  int16_t s;
  int32_t _231;
  uint8_t *_278;
  int16_t _280;
  int16_t _279;
  _278 = _166;
  _280 = _176;
  _279 = _175;
  _231 = 0;
  fn196();
  fn198();
  _200 = 0;
  _209 = (int16_t)_161->ReadBuffer(_278, _279);
  s = (int16_t)(_209 & _280);
  _169 = 0;
  _168 = 0;
  _201 = (int16_t)(((_278[_200] << CONST__154) ^ (_278[_200 + 1])) &
                   (CONST__153 - 1));
  _201 = (int16_t)(_445(_200, _201) + _279);
  while (_209 > CONST__140 + 4 && !_170) {
    fn199(_200, _201);
    if (_168 < CONST__135) {
      fn202(_278[_200], 0);
      _447(_200, _201);
      _200++;
      _201 = (int16_t)(_445(_200, _201) + _279);
      _209--;
    } else {
      _209 -= _168;
      fn202((uint16_t)(_168 + (UCHAR_MAX + 1 - CONST__135)), _169);
      while (--_168 >= 0) {
        _447(_200, _201);
        _200++;
        _201 = (int16_t)(_445(_200, _201) + _279);
      }
    }
  }
  for (; _209 < CONST__140; _209++) {
    int32_t _203 = _161->ReadChar();
    if (_203 < 0)
      break;
    _278[s] = (unsigned char)_203;
    if (s < CONST__140 - 1)
      _278[s + _279] = _278[s];
    _448(s);
    s = (int16_t)((s + 1) & (_280));
  }
  while (_209 > 0 && !_170) {
    fn199(_200, _201);
    if (_168 > _209)
      _168 = _209;
    if (_168 < CONST__135) {
      _168 = 1;
      fn202(_278[_200], 0);
    } else
      fn202((uint16_t)(_168 + (UCHAR_MAX + 1 - CONST__135)), _169);
    while (--_168 >= 0) {
      int32_t _203 = _161->ReadChar();
      if (_203 < 0)
        break;
      else
        _278[s] = (unsigned char)_203;
      if (s < CONST__140 - 1)
        _278[s + _279] = _278[s];
      _448(s);
      s = (int16_t)((s + 1) & (_280));
      _447(_200, _201);
      _200 = (int16_t)((_200 + 1) & (_280));
      _201 = (int16_t)(_445(_200, _201) + _279);
    }
    while (_168-- >= 0) {
      _447(_200, _201);
      _200 = (int16_t)((_200 + 1) & _280);
      _201 = (int16_t)(_445(_200, _201) + _279);
      _209--;
    }
    if (_162->mStatus < 0)
      return 1;
  }
  if (!_170)
    fn202(CONST__144 + (UCHAR_MAX + 1 - CONST__135), 0);
  fn197();
  if (_170)
    _231 = 1;
  return _231;
}
void RCompress::fn196() {
  int32_t i;
  for (i = 0; i < CONST__141; i++)
    _191[i] = 0;
  for (i = 0; i < CONST__142; i++)
    _193[i] = 0;
  _173 = 0;
  fn205();
  _170 = 0;
  _185 = 1;
  _184 = 0;
  _186 = 0;
  _165[0] = 0;
  _183 = CONST__155;
  _183 -= (uint16_t)((3 * CHAR_BIT) + 6);
}
void RCompress::fn197() {
  if (!_170)
    fn207();
  fn206();
  _183 = 0;
  _184 = 0;
}
void RCompress::fn198() {
  register int16_t *_450;
  register int16_t i;
  _450 = &_163[_175];
  for (i = CONST__153; i > 0; i--)
    *_450++ = CONST__157;
  _450 = _164;
  for (i = _175; i > 0; i--)
    *_450++ = CONST__157;
}
void RCompress::fn199(int16_t _200, int16_t _201) {
  register uint8_t *_451;
  register uint8_t *_278;
  int16_t i, _452, _204, _453;
  _452 = CONST__158;
  _168 = 0;
  _451 = &_166[_200];
  _204 = _201;
  while ((_204 = _163[_204]) != CONST__157) {
    if (--_452 < 0)
      break;
    _278 = &_166[_204];
    if (_451[_168] != _278[_168])
      continue;
    if (_451[0] != _278[0])
      continue;
    if (_451[1] != _278[1])
      continue;
    if (_451[2] != _278[2])
      continue;
    for (i = 3; i < CONST__140; i++)
      if (_451[i] != _278[i])
        break;
    if (i > _168) {
      _453 = (int16_t)(_200 - _204 - 1);
      if (_453 < 0)
        _453 += _175;
      if (_453 >= _175) {
        break;
      }
      _169 = _453;
      if ((_168 = i) >= CONST__140)
        break;
    }
  }
}
void RCompress::fn202(uint16_t _203, uint16_t _204) {
  if ((_185 >>= 1) == 0) {
    _185 = 1U << (CHAR_BIT - 1);
    if (_184 >= _183) {
      fn207();
      if (_170)
        return;
      _184 = 0;
    }
    _186 = _184++;
    _165[_186] = 0;
  }
  _165[_184++] = (uint8_t)_203;
  _191[_203]++;
  if (_203 >= (1U << CHAR_BIT)) {
    _165[_186] |= (uint8_t)_185;
    _165[_184++] = (uint8_t)_204;
    _165[_184++] = (uint8_t)(_204 >> CHAR_BIT);
    _203 = 0;
    while (_204) {
      _203++;
      _204 >>= 1;
    }
    _193[_203]++;
  }
}
void RCompress::fn205() {
  _172 = 0;
  _182 = 0;
  _171 = 0;
}
void RCompress::fn206() {
  if (!_170) {
    fn208(CHAR_BIT - 1, 0);
    if (_171)
      fn210();
  }
  _171 = 0;
}
void RCompress::fn207() {
  uint32_t i, _289, _229, _454, _455;
  uint32_t _456 = 0;
  uint16_t _217[2 * CONST__145 - 1];
  _229 = fn211(CONST__141, _191, _180, _192);
  _455 = _191[_229];
  fn208(16, (uint16_t)_455);
  if (_229 >= CONST__141) {
    fn216(_217);
    _229 = fn211(CONST__145, _217, _181, _194);
    if (_229 >= CONST__145) {
      fn218(CONST__145, CONST__147, 3);
    } else {
      fn208(CONST__147, 0);
      fn208(CONST__147, (uint16_t)_229);
    }
    fn222();
  } else {
    fn208(CONST__147, 0);
    fn208(CONST__147, 0);
    fn208(CONST__143, 0);
    fn208(CONST__143, (uint16_t)_229);
  }
  _229 = fn211(CONST__142, _193, _181, _194);
  if (_229 >= CONST__142) {
    fn218(CONST__142, CONST__540, -1);
  } else {
    fn208(CONST__540, 0);
    fn208(CONST__540, (uint16_t)_229);
  }
  _454 = 0;
  for (i = 0; i < _455; i++) {
    if (i % CHAR_BIT == 0)
      _456 = _165[_454++];
    else
      _456 <<= 1;
    if (_456 & (1U << (CHAR_BIT - 1))) {
      fn223((int16_t)(_165[_454++] + (1U << CHAR_BIT)));
      _289 = _165[_454++];
      _289 += _165[_454++] << CHAR_BIT;
      fn224((int16_t)_289);
    } else
      fn223(_165[_454++]);
    if (_170)
      return;
  }
  for (i = 0; i < CONST__141; i++)
    _191[i] = 0;
  for (i = 0; i < CONST__142; i++)
    _193[i] = 0;
}
void RCompress::fn208(int32_t _209, uint16_t _203) {
  _203 <<= CONST__133 - _209;
  _182 |= (uint16_t)(_203 >> _172);
  if ((_172 += (int16_t)_209) >= 8) {
    if (_171 >= CONST__156)
      fn210();
    _179[_171++] = (uint8_t)(_182 >> CHAR_BIT);
    if ((_172 = (uint16_t)(_172 - CHAR_BIT)) < CHAR_BIT)
      _182 <<= CHAR_BIT;
    else {
      if (_171 >= CONST__156)
        fn210();
      _179[_171++] = (uint8_t)_182;
      _172 = (uint16_t)(_172 - CHAR_BIT);
      _182 = (uint16_t)(_203 << (_209 - _172));
    }
  }
}
void RCompress::fn210() {
  if (_171 <= 0)
    return;
  if (_531 && (_533 += _171) >= _534)
    _170 = 1;
  else
    _162->WriteBuffer(_179, _171);
  _171 = 0;
}
int32_t RCompress::fn211(int32_t _212, uint16_t *_213, uint8_t *_214,
                         uint16_t *_215) {
  int32_t i, _276, _289, _292;
  int16_t _227;
  _174 = (int16_t)_212;
  _187 = _213;
  _178 = _214;
  _292 = _174;
  _227 = 0;
  _177[1] = 0;
  for (i = 0; i < _174; i++) {
    _178[i] = 0;
    if (_187[i])
      _177[++_227] = (int16_t)i;
  }
  if (_227 < 2) {
    _215[_177[1]] = 0;
    return _177[1];
  }
  for (i = _227 / 2; i >= 1; i--)
    fn225(i, _187, _177, _227);
  _188 = _215;
  do {
    i = _177[1];
    if (i < _174)
      *_188++ = (uint16_t)i;
    _177[1] = _177[_227--];
    fn225(1, _187, _177, _227);
    _276 = _177[1];
    if (_276 < _174)
      *_188++ = (uint16_t)_276;
    _289 = _292++;
    _187[_289] = (uint16_t)(_187[i] + _187[_276]);
    _177[1] = (int16_t)_289;
    fn225(1, _187, _177, _227);
    _189[_289] = (uint16_t)i;
    _190[_289] = (uint16_t)_276;
  } while (_227 > 1);
  _188 = _215;
  fn228(_289);
  fn230(_212, _214, _215);
  return _289;
}
void RCompress::fn216(uint16_t *_217) {
  int16_t i, _289, _219, _277;
  for (i = 0; i < CONST__145; i++)
    _217[i] = 0;
  _219 = CONST__141;
  while (_219 > 0 && _180[_219 - 1] == 0)
    _219--;
  i = 0;
  while (i < _219) {
    _289 = _180[i++];
    if (_289 == 0) {
      _277 = 1;
      while (i < _219 && _180[i] == 0) {
        i++;
        _277++;
      }
      if (_277 <= 2)
        _217[0] += _277;
      else if (_277 <= 18)
        _217[1]++;
      else if (_277 == 19) {
        _217[0]++;
        _217[1]++;
      } else
        _217[2]++;
    } else
      _217[_289 + 2]++;
  }
}
void RCompress::fn218(int16_t _219, int16_t _220, int16_t _221) {
  int16_t i, _289;
  while (_219 > 0 && _181[_219 - 1] == 0)
    _219--;
  fn208(_220, _219);
  i = 0;
  while (i < _219) {
    _289 = _181[i++];
    if (_289 <= 6) {
      fn208(3, _289);
    } else
      fn208(_289 - 3, (uint16_t)(USHRT_MAX << 1));
    if (i == _221) {
      while (i < 6 && _181[i] == 0)
        i++;
      fn208(2, (uint16_t)(i - 3));
    }
  }
}
void RCompress::fn222() {
  int16_t i, _289, _219, _277;
  _219 = CONST__141;
  while (_219 > 0 && _180[_219 - 1] == 0)
    _219--;
  fn208(CONST__143, _219);
  i = 0;
  while (i < _219) {
    _289 = _180[i++];
    if (_289 == 0) {
      _277 = 1;
      while (i < _219 && _180[i] == 0) {
        i++;
        _277++;
      }
      if (_277 <= 2) {
        for (_289 = 0; _289 < _277; _289++)
          fn208(_181[0], _194[0]);
      } else if (_277 <= 18) {
        fn208(_181[1], _194[1]);
        fn208(4, (uint16_t)(_277 - 3));
      } else if (_277 == 19) {
        fn208(_181[0], _194[0]);
        fn208(_181[1], _194[1]);
        fn208(4, 15);
      } else {
        fn208(_181[2], _194[2]);
        fn208(CONST__143, (uint16_t)(_277 - 20));
      }
    } else
      fn208(_181[_289 + 2], _194[_289 + 2]);
  }
}
void RCompress::fn224(uint16_t _204) {
  uint16_t _203, _457;
  _203 = 0;
  _457 = _204;
  while (_457) {
    _203++;
    _457 >>= 1;
  }
  fn208(_181[_203], _194[_203]);
  if (_203 > 1)
    fn208(_203 - 1, _204);
}
void RCompress::fn225(int32_t i, uint16_t *_187, int16_t *_177, int16_t _227) {
  int32_t _276, _289;
  _289 = _177[i];
  while ((_276 = 2 * i) <= _227) {
    if (_276 < _227 && _187[_177[_276]] > _187[_177[_276 + 1]])
      _276++;
    if (_187[_289] <= _187[_177[_276]])
      break;
    _177[i] = _177[_276];
    i = _276;
  }
  _177[i] = (uint16_t)_289;
}
void RCompress::fn228(int32_t arg229) {
  int32_t i, _289;
  uint32_t _458;
  for (i = 0; i <= 16; i++)
    _167[i] = 0;
  fn232(arg229);
  _458 = 0;
  for (i = 16; i > 0; i--)
    _458 += _167[i] << (16 - i);
  while (_458 != (1U << 16)) {
    _167[16]--;
    for (i = 15; i > 0; i--) {
      if (_167[i] != 0) {
        _167[i]--;
        _167[i + 1] = (uint16_t)(_167[i + 1] + 2);
        break;
      }
    }
    _458--;
  }
  for (i = 16; i > 0; i--) {
    _289 = _167[i];
    while (--_289 >= 0)
      _178[*_188++] = (uint8_t)i;
  }
}
void RCompress::fn230(int32_t arg219, uint8_t *arg209, uint16_t *arg231) {
  int32_t i;
  uint16_t local288[18];
  local288[1] = 0;
  for (i = 1; i <= 16; i++)
    local288[i + 1] = (uint16_t)((local288[i] + _167[i]) << 1);
  for (i = 0; i < arg219; i++)
    arg231[i] = local288[arg209[i]]++;
}

void RCompress::fn232(int32_t arg226) {
  if (arg226 < _174)
    _167[(_173 < 16) ? _173 : 16]++;
  else {
    _173++;
    fn232(_189[arg226]);
    fn232(_190[arg226]);
    _173--;
  }
}
